{% extends "base.html" %}
{% set title = project.name %}

{% block content %}
<style>
.maps-container {
  display: flex;
  flex-direction: column;
  gap: 1em;
}

@media (min-width: 1280px) {
  .maps-container {
    flex-direction: row;
  }
  .map {
    flex: 1;
    min-width: 0;
  }
}

.map {
 width: 100%;
 max-width: 640px;
}
.shapes svg {
 width: 100%;
 fill: #0b0c0c;
 padding: 2.5em;
}
.points svg {
 width: 100%;
 fill: #0b0c0c;
 padding: 2.5em;
}
svg path {
  fill:none;
  stroke:#000;
  stroke-width:0.5px;
}
svg circle {
  fill:red;
  opacity: 0.125;
}
svg a {
  cursor: pointer;
}
svg path.Software,
svg path.PropTech_Software,
svg path.Plan-making_Software,
svg path.Plan-making_PropTech_Software,
svg path.PropTech,
svg path.Plan-making_PropTech,
svg path.Plan-making { fill: #d4351c; stroke: #000; stroke-width: 0.5px }
svg path:hover { opacity: 0.5 }

.stacked-chart {
  display: flex;
  width: 100%;
  margin: 1em 0;
}

.stacked-chart .bar {
  display: flex;
  justify-content: left;
  align-items: center;
  height: 2em;
  text-indent: 1em;
  color: #ffffff;
}

ul.key {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

li.key-item {
   border-left: 16px solid;
   margin-bottom: 5px;
   padding-left: 5px;
}

{% for item in legends %}
.stacked-chart .bar.{{ item.reference }} { background-color: {{ item.colour }}; color: #000 }
.key-item.{{ item.reference }} { border-color: {{ item.colour }}; }
{% endfor %}

/* sortable table */
th[role=columnheader]:not(.no-sort) {
	cursor: pointer;
}

th[role=columnheader]:not(.no-sort):after {
	content: '';
	float: right;
	margin-top: 7px;
	border-width: 0 4px 4px;
	border-style: solid;
	border-color: #404040 transparent;
	visibility: hidden;
	opacity: 0;
	-ms-user-select: none;
	-webkit-user-select: none;
	-moz-user-select: none;
	user-select: none;
}

th[aria-sort=ascending]:not(.no-sort):after {
	border-bottom: none;
	border-width: 4px 4px 0;
}

th[aria-sort]:not(.no-sort):after {
	visibility: visible;
	opacity: 0.4;
}

th[role=columnheader]:not(.no-sort):hover:after {
	visibility: visible;
	opacity: 1;
}

/* timeline chart */
.timeline-chart {
  display: flex;
  align-items: flex-end;
  width: 100%;
  padding: 2em 0;
  margin: 1em 0;
}

.timeline-year-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
}

.timeline-year-bars {
  display: flex;
  align-items: flex-end;
  width: 100%;
}

.timeline-bar {
  flex: 1;
  background-color: #1d70b8;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding-top: 0.5em;
  min-height: 2em;
}

.timeline-count {
  color: white;
  font-weight: bold;
  font-size: 0.8em;
}

.timeline-year-label {
  font-weight: bold;
  font-size: 0.9em;
  margin-top: 0.5em;
}
</style>

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <span class="govuk-caption-xl">Project</span>
        <h1 class="govuk-heading-xl">{{ project.name }}</h1>

        {% if project.description %}
        <p class="govuk-body">{{ project.description }}</p>
        {% endif %}


        <h2 class="govuk-heading-m">Organisations</h2>

        <div class="maps-container">
            <div class="shapes map">
            {{ shapes_svg|safe }}
            </div>
        </div>

        {% if timeline_bars %}
        <h2 class="govuk-heading-m">Timeline</h2>
        <div class="timeline-chart">
            {% for year_data in timeline_bars %}
            <div class="timeline-year-group">
                <div class="timeline-year-bars">
                    {% set all_same = year_data.quarters[0] == year_data.quarters[1] == year_data.quarters[2] == year_data.quarters[3] %}
                    {% for count in year_data.quarters %}
                    <div class="timeline-bar" style="height: {{ (count / max_count * 200)|round(0) }}px;">
                        {% if all_same and loop.index == 3 %}
                        <span class="timeline-count">{{ count }}</span>
                        {% elif not all_same %}
                        <span class="timeline-count">{{ count }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                <div class="timeline-year-label">{{ year_data.year }}</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <table id="organisations-table" class="govuk-table sortable">
            <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                    <th scope="col" class="govuk-table__header">Start date</th>
                    <th scope="col" class="govuk-table__header" aria-sort="ascending">Organisation</th>
                    <th scope="col" class="govuk-table__header">Interventions</th>
                </tr>
            </thead>
            <tbody class="govuk-table__body">
                {% for org in organisations %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">{{ org.start_date|govuk_date }}</td>
                    <td class="govuk-table__cell">
                        <a href="{{BASE_PATH}}/organisation/{{ org.organisation }}/">{{ org.name }}</a>
                    </td>
                    <td class="govuk-table__cell">
                        {% for intervention in org.interventions %}
                        <a href="{{BASE_PATH}}/intervention/{{ intervention.intervention }}/">{{ intervention.name }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js" integrity="sha512-F/gIMdDfda6OD2rnzt/Iyp2V9JLHlFQ+EUyixDg9+rkwjqgW1snpkpx7FD5FV1+gG2fmFj7I3r6ReQDUidHelA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
new Tablesort(document.getElementById('organisations-table'));
</script>

{% endblock content %}
