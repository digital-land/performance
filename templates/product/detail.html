{% extends "base.html" %}
{% set title = product.name %}

{% block content %}
<style>
.chart {
  width: 100%;
  max-width: 100%;
  min-height: 450px;
}

.timeline-container {
  width: 100%;
  margin: 2em 0;
  font-size: 0.9em;
}

.timeline-header {
  display: flex;
  margin-bottom: 0.5em;
  border-bottom: 2px solid #b1b4b6;
}

.timeline-labels {
  width: 200px;
  flex-shrink: 0;
}

.timeline-axis {
  flex: 1;
  display: flex;
  justify-content: space-between;
  padding: 0 0.5em;
}

.timeline-year {
  font-weight: bold;
  color: #0b0c0c;
}

.timeline-row {
  display: flex;
  margin-bottom: 0.25em;
  min-height: 2em;
  align-items: center;
}

.timeline-label {
  width: 200px;
  flex-shrink: 0;
  padding-right: 1em;
  font-size: 0.9em;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.timeline-track {
  flex: 1;
  position: relative;
  height: 1.5em;
  background-color: #f3f2f1;
  border: 1px solid #b1b4b6;
}

.timeline-bar {
  height: 100%;
  background-color: #12436d;
  position: absolute;
  top: 0;
}

.tooltip {
    background:#fff;
    padding:10px;
    border-style:solid;
}

.treemap-container {
  width: 100%;
  overflow-x: auto;
  margin: 2em 0;
}

.treemap-container svg {
  display: block;
  margin: 0 auto;
  max-width: 100%;
  height: auto;
}

.adoption-bar-chart {
  margin: 2em 0;
}

.adoption-bar-row {
  display: flex;
  align-items: center;
  margin-bottom: 1em;
}

.adoption-bar-label {
  width: 280px;
  flex-shrink: 0;
  padding-right: 1em;
  font-size: 16px;
  font-family: "GDS Transport", arial, sans-serif;
}

.adoption-bar-container {
  flex: 1;
  position: relative;
  height: 40px;
  background-color: #f3f2f1;
}

.adoption-bar {
  height: 100%;
  background-color: #12436d;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 10px;
  transition: width 0.3s ease;
}

.adoption-bar-count {
  color: #ffffff;
  font-weight: bold;
  font-size: 19px;
  white-space: nowrap;
}
</style>

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <span class="govuk-caption-xl">Product</span>
        <h1 class="govuk-heading-xl">{{ product.name }}</h1>

        {% if product.description %}
        <p class="govuk-body">{{ product.description }}</p>
        {% endif %}

        <h2 class="govuk-heading-l" id="funnel">Adoption funnel</h2>
        <p class="govuk-body">Organisations potentially able to adopt {{ product.name }}.</p>

        <div class="adoption-bar-chart">
            {% set max_count = counts.lpa %}

            <div class="adoption-bar-row">
                <div class="adoption-bar-label">Local Planning Authority</div>
                <div class="adoption-bar-container">
                    <div class="adoption-bar" style="width: {{ (counts.active_lpa / max_count * 100)|round(1) }}%;">
                        <span class="adoption-bar-count">{{ counts.active_lpa }}</span>
                    </div>
                </div>
            </div>

            <div class="adoption-bar-row">
                <div class="adoption-bar-label"><a href="{{BASE_PATH}}/award/">Awarded funding</a></div>
                <div class="adoption-bar-container">
                    <div class="adoption-bar" style="width: {{ (counts.funded / max_count * 100)|round(1) }}%;">
                        <span class="adoption-bar-count">{{ counts.funded }}</span>
                    </div>
                </div>
            </div>

            <div class="adoption-bar-row">
                <div class="adoption-bar-label">Funded for Software</div>
                <div class="adoption-bar-container">
                    <div class="adoption-bar" style="width: {{ (counts.software / max_count * 100)|round(1) }}%;">
                        <span class="adoption-bar-count">{{ counts.software }}</span>
                    </div>
                </div>
            </div>

            <div class="adoption-bar-row">
                <div class="adoption-bar-label">Providing some data</div>
                <div class="adoption-bar-container">
                    {% if counts.providing > 0 %}
                    <div class="adoption-bar" style="width: {{ (counts.providing / max_count * 100)|round(1) }}%;">
                        <span class="adoption-bar-count">{{ counts.providing }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="adoption-bar-row">
                <div class="adoption-bar-label">Data ready for {{ product.name }}</div>
                <div class="adoption-bar-container">
                    {% if counts.data_ready > 0 %}
                    <div class="adoption-bar" style="width: {{ (counts.data_ready / max_count * 100)|round(1) }}%;">
                        <span class="adoption-bar-count">{{ counts.data_ready }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="adoption-bar-row">
                <div class="adoption-bar-label">Preparing to launch {{ product.name }}</div>
                <div class="adoption-bar-container">
                    {% if counts.interested_or_adopting > 0 %}
                    <div class="adoption-bar" style="width: {{ (counts.interested_or_adopting / max_count * 100)|round(1) }}%;">
                        <span class="adoption-bar-count">{{ counts.interested_or_adopting }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="adoption-bar-row">
                <div class="adoption-bar-label"><a href="#organisations">Have adopted {{ product.name }}</a></div>
                <div class="adoption-bar-container">
                    {% if counts.live > 0 %}
                    <div class="adoption-bar" style="width: {{ (counts.live / max_count * 100)|round(1) }}%;">
                        <span class="adoption-bar-count">{{ counts.live }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

        {% if timeline_data %}
        <h2 class="govuk-heading-l" id="timeline">Adoption timeline</h2>
        <p class="govuk-body">Timeline of organisations adopting {{ product.name }}.</p>

        <div class="timeline-container">
            <div class="timeline-header">
                <div class="timeline-labels"></div>
                <div class="timeline-axis">
                    {% for year in timeline_years %}
                    <div class="timeline-year">{{ year }}</div>
                    {% endfor %}
                </div>
            </div>
            {% for item in timeline_data %}
            <div class="timeline-row">
                <div class="timeline-label">{{ item.area_name }}</div>
                <div class="timeline-track">
                    <div class="timeline-bar" style="margin-left: {{ item.offset_percent }}%; width: {{ item.width_percent }}%;"></div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if treemap_svg %}
        <h2 class="govuk-heading-l">Funding and adoption</h2>

        <div class="treemap-container">
            {{ treemap_svg|safe }}
        </div>
        {% endif %}

        <h2 class="govuk-heading-l" id="organisations">Organisations</h2>

        <table class="govuk-table">
            <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                    <th scope="col" class="govuk-table__header">Date</th>
                    <th scope="col" class="govuk-table__header">Organisation</th>
                    <th scope="col" class="govuk-table__header">Status</th>
                </tr>
            </thead>
            <tbody class="govuk-table__body">
                {% for adoption in adoptions %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">{{ adoption.start_date|govuk_date }}</td>
                    <td class="govuk-table__cell">
                        <a href="{{BASE_PATH}}/organisation/{{ adoption.organisation }}/">{{ adoption.org_name }}</a>
                    </td>
                    <td class="govuk-table__cell">
                        {% if adoption.documentation_url %}<a href="{{ adoption.documentation_url }}">
                        {% endif -%}
                        {{ adoption.adoption_status }}
                        {%- if adoption.documentation_url %}<a href="{{ adoption.documentation_url }}">
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock content %}
